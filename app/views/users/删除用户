删除用户

我们知道删除用户只有管理员才能够
做所以我们第一步就要设置管理员用户
1.必须向数据库中加上管理员用户，首先我们要生成迁移文件
rails generate migration add_admin_to_users admin:boolean

2.修改一下迁移文件
db/migrate/[timestamp]_add_admin_to_users.rb
class AddAdminToUsers < ActiveRecord::Migration
	def change
		add_column :users, :admin, :boolean, default: false
	end
end

我们默认设置迁移文件的admin的值为false
添加这个参数后用户默认情况下不是管理员


3.向数据库中添加迁移文件
rake db:migrate

4.生成示例用户的代码，把第一个用户设为管理员

namespace :db do
	desc "Fill database with sample data"
		task populate: :environment do
			admin = User.create!(name: "Example User",
														email: "example@railstutorial.org",
														password: "foobar",
														password_confirmation: "foobar")
			admin.toggle!(:admin)
			99.times do |n|
				name = Faker::Name.name
				email = "example-#{n+1}@railstutorial.org"
				password = "password"
				User.create!(name: name,
											email: email,
											password: password,
											password_confirmation: password)
		end
	end
end


之后还要还原数据库，并且重新生成示例用户：
bundle exec rake db:reset
bundle exec rake db:populate
bundle exec rake db:test:prepare



5.下面来开始删除操作

删除用户的链接（只有管理员才能看到）
app/views/users/_user.html.erb
<li>
<%= gravatar_for user, size: 52 %>
<%= link_to user.name, user %>
<% if current_user.admin? %>
 <%= link_to "delete", user, method: :delete, data: { confirm: "You sure?" }%>
<% end %>
</li>

6.加入 destroy 动作
before_filter :signed_in_user, only: [:index, :edit, :update, :destroy]

def destroy
	User.find(params[:id]).destroy
	flash[:success] = "User destroyed."
	redirect_to users_path
end



7.限制只有管理员才能访问 destroy 动作的事前过滤器
before_filter :admin_user, only: :destroy


def admin_user
		redirect_to(root_path) unless current_user.admin?
end


上面已经实现了删除用户的操作
梳理一下流程
1.在这面中我们要判断这是不是管理员用户
<% if current_user.admin? %>
<% link_to "delete", method: :delete, data: {confirm: "You sure?"}%>


2.点击删除按钮则交给users控制器下的destroy动作进行处理
首先必须要登录才能够进行这个操作
before_filter :signed_in_user, only: [:index, :edit, :update, :destroy]

def signed_in_user
	redirect_to signin_path, notice: "Please sign in." unless signed_in
end

或者这个方法还可以这么写
def signed_in_user
	flash[:notice] = "Please sign in."
	redirect_to signin_path
end


def destroy
	User.find(params[:id]).destroy
	flash[:success] = "User destroyed."
	redirect_to users_path
end

3.我们在限制一下只有管理员才能够进行这些操作
before_filter :admin_user, only: :destroy

def admin_user
		redirect_to(root_path) unless current_user.admin?
end
